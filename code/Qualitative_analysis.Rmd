---
title: "DaSEH Qualitative Analysis"
date: "2025-10-01"
output:
  html_document:
    toc: true
  pdf_document:
    toc: true
---

## Load Libraries

```{r libraries}
library(googlesheets4) # Access Google Sheets using the Sheets API V4 CRAN v1.1.1
library(tidyverse) # Easily Install and Load the 'Tidyverse' CRAN v2.0.0
library(tidytext) # Text Mining using 'dplyr', 'ggplot2', and Other Tidy Tools CRAN v0.4.2
library(patchwork) # The Composer of Plots CRAN v1.2.0
library(wordcloud) # Word Clouds CRAN v2.6
```

## Renaming and Combining

```{r cleanup}
# Authenticate once
gs4_auth(email = TRUE)

# Google Sheet links
qualitative_sheet_link <- 
  "https://docs.google.com/spreadsheets/d/1t8Dgl_hcFBIg3QryEcNsAbB0asUDRGb_KjZoZVkcBHM/edit?usp=sharing"

feedback <-
  read_sheet(qualitative_sheet_link, sheet = "Qualitative") %>%
  rename(
    `Online Course` = `Please provide any feedback that you think could help us improve the DaSEH Online Course. (POST COURSE)`,
    `Code-a-thon Modality` = `Please provide any suggestions regarding the Code-a-thon modality. This could be logistics, timing, projects, topics covered, standups, code review, lightning talks, etc. (POST CODE-A-THON)`,
    `Code-a-thon Feedback` = `Please provide any feedback that you think could help us improve the DaSEH Code-a-thon. You can provide anonymous feedback here: https://forms.gle/hQ7jdHZSZoDpHAdE6. (POST CODE-A-THON)`
  ) %>%
  mutate(`Code-a-thon` = paste(`Code-a-thon Modality`, `Code-a-thon Feedback`)) %>%
  select(-`Code-a-thon Modality`, -`Code-a-thon Feedback`) %>%
  select(-`...1`)

feedback <-
  feedback %>%
  mutate(student = as.factor(seq(1,nrow(feedback))))
```

## Pivot to Long Format 

```{r pivot}
feedback_long <- feedback %>%
  pivot_longer(cols = !student,
               names_to = "question",
               values_to = "response") %>%
  filter(!is.na(response))
```

## Remove Stop Words 

```{r stop words}
tidy_feedback <- feedback_long %>%
  unnest_tokens(word, response) %>%
  anti_join(stop_words)
```

## Get Sentiment Lexicons 

```{r sentiment lexicons}
# May need to be run interactively
bing <- get_sentiments("bing") # ?textdata::lexicon_bing
afinn <- get_sentiments("afinn") # ?textdata::lexicon_afinn
```

## Afinn Sentiments (Weighted from -5 to 5)

We calculated sentiment for each optional free text response using the AFINN lexicon, which rates words between -5 (negative) and 5 (positive) (`?textdata::lexicon_afinn` for citation).

Affinity scores of optional free text responses by student. Values reflect the sum total positive (green) and negative (yellow) words, where each relevant word can be assigned a value from -5 (most negative sentiment) to 5 (most positive sentiment). Neutral words were excluded. 
 
```{r afinn sentiments}
afinn_sentiments <-
  tidy_feedback %>%
  inner_join(afinn, by = "word") %>%
  mutate(question = factor(
    question,
    levels = c("Online Course", "Code-a-thon"),
    labels = c("Online Course", "Codeathon")
  )) %>%
  mutate(sentiment = case_when(value < 0 ~ "negative", value > 0 ~ "positive"))

p_afinn <-
  ggplot(afinn_sentiments) +
  geom_col(aes(x = student, y = value, fill = sentiment), position = "stack") +
  facet_wrap(~ question, scales = "free_x") +
  scale_fill_manual(values = c(
    "positive" = "#5ab4ac",
    "negative" = "#d8b364"
  )) +
  labs(y = "Affinity score", x = "Learner ID")
```

## Top Positive and Negative Words

We also counted the most common words with either positive or negative sentiment, according to the Bing lexicon  (`?textdata::lexicon_bing` for citation).

Most common words (>= 2 occurrences) matching a positive or negative Bing lexicon sentiment across optional free text responses. Total occurrences are summed across respondents.

```{r top words}
top_words <-
  tidy_feedback %>%
  inner_join(bing, by = "word") %>%
  mutate(
    word = case_when(
      word == "helpful" ~ "helpful / helped",
      word == "helped" ~ "helpful / helped",
      word == "break" ~ "break(s)",
      word == "breaks" ~ "break(s)",
      TRUE ~ word
    )
  ) %>%
  count(question, word, sentiment, sort = TRUE) %>%
  mutate(question = factor(
    question,
    levels = c("Online Course", "Code-a-thon"),
    labels = c("Online Course", "Codeathon")
  )) %>%
  filter(n > 1)

p_topwords <-
  top_words %>%
  group_by(question, sentiment) %>%
  ungroup() %>%
  mutate(sentiment = factor(sentiment, levels = c("positive", "negative"))) %>%
  ggplot(aes(
    y = n,
    x = reorder_within(word, desc(n), question),
    fill = sentiment
  )) +
  geom_col(show.legend = FALSE) +
  facet_wrap(question ~ ., scales = "free_x") +
  scale_x_reordered() +
  scale_fill_manual(values = c(
    "positive" = "#5ab4ac",
    "negative" = "#d8b364"
  )) +
  scale_y_continuous(breaks = seq(2, 10, 2)) +
  labs(y = "Total occurrences", x = NULL)
```

## Make Composite Figure

The following combines the previous two plots, writes to file, and adds themeing.

Learners' optional free text responses for solicited feedback indicated generally positive sentiment for the online course, with some areas for improvement. In contrast, learners felt strongly positive about the codeathon. For both the online course and codeathon, words like "helpful" and "appreciated" were common. Learners also felt "break(s)" were important and mentioned them in both positive and negative contexts.

```{r composite figure}
make_theme <- function(in_plot) {
  in_plot +
    theme(
      axis.ticks = element_blank(),
      strip.background = element_rect(fill = '#F0F0F0', color = '#F0F0F0'),
      panel.background = element_rect(
        size = 1,
        color = 'grey70',
        fill = NA
      ),
      legend.position = "none",
      plot.margin = unit(c(0, 0, 0, 0), "cm")
    )
}

combined_plot <-
  make_theme(p_afinn) +
  make_theme(p_topwords) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  plot_layout(design = "
    A
    B
    ", heights = c(1, 1.5))+
  plot_annotation(tag_prefix = "(",
                  tag_levels = "a",
                  tag_suffix = ")")

combined_plot

ggsave(
  "figures/daseh_composite_sentiment.pdf",
  plot = combined_plot,
  width = 8,
  height = 7,
  dpi = 300
)
``` 

## Word Cloud (Limited to 200 words)

```{r word cloud}
word_freq <- tidy_feedback %>%
  count(word, sort = TRUE)

par(mar = c(1, 1, 1, 1))

png(
  "figures/daseh_wordcloud.png",
  width = 2000,
  height = 1200,
  res = 200
)

wordcloud(
  words = word_freq$word,
  freq = word_freq$n,
  max.words = 200,
  scale = c(3.5, 0.7),
  random.order = FALSE,
  rot.per = 0.15,
  colors = rep(c("#5ab4ac", "#d8b364"), length.out = 200)
)

dev.off()
```


