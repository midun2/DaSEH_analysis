---
title: "DaSEH Qualitative Analysis"
date: "2025-10-01"
output:
  html_document:
    css: daseh.css
    toc: true
  pdf_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

## Load Libraries

```{r libraries}
library(googlesheets4)
library(tidyverse)
library(readxl)
library(wordcloud)
library(ggplot2)
library(textdata)  
library(knitr)     
library(patchwork)
```

## Renaming and Combining

```{r cleanup}
# # Authenticate once
# gs4_auth(email = TRUE)
# 
# # Google Sheet links
# qualitative_sheet_link <- "https://docs.google.com/spreadsheets/d/1t8Dgl_hcFBIg3QryEcNsAbB0asUDRGb_KjZoZVkcBHM/edit?usp=sharing"
# 
# feedback <-
#   read_sheet(qualitative_sheet_link, sheet = "Qualitative") %>%
#   rename(
#     `Online Course` = `Please provide any feedback that you think could help us improve the DaSEH Online Course. (POST COURSE)`,
#     `Code-a-thon Modality` = `Please provide any suggestions regarding the Code-a-thon modality. This could be logistics, timing, projects, topics covered, standups, code review, lightning talks, etc. (POST CODE-A-THON)`,
#     `Code-a-thon Feedback` = `Please provide any feedback that you think could help us improve the DaSEH Code-a-thon. You can provide anonymous feedback here: https://forms.gle/hQ7jdHZSZoDpHAdE6. (POST CODE-A-THON)`
#   ) %>%
#   mutate(`Code-a-thon` = paste(`Code-a-thon Modality`, `Code-a-thon Feedback`)) %>%
#   select(-`Code-a-thon Modality`, -`Code-a-thon Feedback`) %>% 
#   select(-`...1`)
```

## Pivot to Long Format 

```{r pivot}
feedback_long <- feedback %>%
  pivot_longer(cols = everything(),
               names_to = "question",
               values_to = "response") %>%
  filter(!is.na(response))
```

## Remove Stop Words 

```{r stop words}
tidy_feedback <- feedback_long %>%
  unnest_tokens(word, response) %>%
  anti_join(stop_words)
```

## Get Sentiment Lexicons 

```{r sentiment lexicons}
# Must be run interactively
bing <- get_sentiments("bing")
afinn <- get_sentiments("afinn")
nrc <- textdata::lexicon_nrc()
```

## Bing Sentiments (Positive Sentiments - Negative Sentiments)

```{r bing sentiments}
bing_sentiments <- tidy_feedback %>%
  inner_join(bing, by = "word") %>%
  count(question, sentiment) %>%
  pivot_wider(names_from = sentiment,
              values_from = n,
              values_fill = 0) %>%
  mutate(net_sentiment = positive - negative)

p_bing <- ggplot(bing_sentiments) +
  geom_col(aes(y = question, x = net_sentiment), fill = "#5ab4ac") +
  labs(x = "Net sentiment (Bing lexicon)")
```

## Afinn Sentiments (Weighted from -5 to 5)

```{r afinn sentiments}
afinn_sentiments <- tidy_feedback %>%
  inner_join(afinn, by = "word") %>%
  group_by(question) %>%
  summarise(afinn_score = sum(value), .groups = "drop")

p_afinn <- ggplot(afinn_sentiments,
                  aes(
                    x = reorder(question, afinn_score),
                    y = afinn_score,
                    fill = afinn_score > 0
                  )) +
  geom_col(show.legend = FALSE) +
  coord_flip() +
  scale_fill_manual(values = c("TRUE" = "#5ab4ac", "FALSE" = "#d8b364")) +
  labs(y = "Affinity score")
```

## NRC Sentiments (with Emotions)

```{r nrc sentiments}
nrc_sentiments <- tidy_feedback %>%
  inner_join(nrc, by = "word", relationship = "many-to-many") %>% # Note that a word can match multiple sentiments
  count(question, sentiment, sort = TRUE) %>%
  mutate(question = factor(
    question,
    levels = c("Online Course", "Code-a-thon"),
    labels = c("Online Course", "Codeathon")
  ))

p_nrc <- nrc_sentiments %>%
  ggplot(aes(
    x = reorder_within(sentiment, n, question),
    y = n,
    fill = sentiment
  )) +
  geom_col(show.legend = TRUE) +
  facet_wrap(~ question, scales = "free_y") +
  scale_x_reordered() +
  coord_flip() +
  scale_fill_manual(
    values = c(
      "positive" = "#5ab4ac",
      "negative" = "#d8b364",
      "joy"      = "#5ab4ac",
      "trust"    = "#5ab4ac",
      "anger"    = "#d8b364",
      "sadness"  = "#d8b364",
      "fear"     = "#d8b364",
      "anticipation"  = "#d8b364",
      "disgust"  = "#d8b364"
    )
  ) +
  labs(x = "NRC Sentiment Type", y = "Word count", fill = "Emotion") +
  theme_classic() +
  theme(legend.position = "none")
```

## Top 10 Positive and Negative Words

```{r top words}
top_words <- tidy_feedback %>%
  inner_join(bing, by = "word") %>%
  mutate(
    word = case_when(
      word == "helpful" ~ "helpful / helped",
      word == "helped" ~ "helpful / helped",
      word == "break" ~ "break(s)",
      word == "breaks" ~ "break(s)",
      TRUE ~ word
    )
  ) %>%
  count(question, word, sentiment, sort = TRUE) %>%
  mutate(question = factor(
    question,
    levels = c("Online Course", "Code-a-thon"),
    labels = c("Online Course", "Codeathon")
  )) %>%
  filter(n > 1)

p_topwords <- top_words %>%
  group_by(question, sentiment) %>%
  ungroup() %>%
  mutate(sentiment = factor(sentiment, levels = c("positive", "negative"))) %>%
  ggplot(aes(n, reorder_within(word, n, question), fill = sentiment)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(question ~ ., scales = "free_y") +
  scale_y_reordered() +
  scale_fill_manual(values = c(
    "positive" = "#5ab4ac",
    "negative" = "#d8b364"
  )) +
  scale_x_continuous(breaks = seq(2, 10, 2)) +
  labs(x = "Word count", y = "Word")
```

## Make Composite Figure

```{r composite figure}
make_theme <- function(in_plot) {
  in_plot +
    theme_classic() +
    theme(
      axis.ticks = element_blank(),
      strip.background = element_rect(fill = '#F0F0F0', color = '#F0F0F0'),
      panel.background = element_rect(
        size = 1,
        color = 'grey70',
        fill = NA
      ),
      legend.position = "none",
      plot.margin = unit(c(0, 1, 0, 0), "cm")
    )
}

combined_plot <-
  make_theme(p_bing) + theme(axis.title.y = element_blank()) +
  make_theme(p_afinn) + theme(axis.title.y = element_blank()) +
  make_theme(p_nrc) +
  make_theme(p_topwords) +
  plot_layout(design = "
    AB
    CC
    DD
    ", heights = c(1, 2, 3)) +
  plot_annotation(tag_prefix = "(",
                  tag_levels = "a",
                  tag_suffix = ")")

combined_plot

ggsave(
  "daseh_composite_sentiment.pdf",
  plot = combined_plot,
  width = 8,
  height = 7,
  dpi = 300
)
``` 

## Word Cloud (Limited to 200 words)

```{r word cloud}
word_freq <- tidy_feedback %>%
  count(word, sort = TRUE)

par(mar = c(1, 1, 1, 1))

png(
  "daseh_wordcloud.png",
  width = 2000,
  height = 1200,
  res = 200
)

wordcloud(
  words = word_freq$word,
  freq = word_freq$n,
  max.words = 200,
  scale = c(3.5, 0.7),
  random.order = FALSE,
  rot.per = 0.15,
  colors = rep(c("#5ab4ac", "#d8b364"), length.out = 200)
)

dev.off()
```
